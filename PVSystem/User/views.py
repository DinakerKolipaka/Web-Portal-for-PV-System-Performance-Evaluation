from django.shortcuts import render
from django.shortcuts import redirect
from django.core.urlresolvers import reverse
from django.http import HttpResponseRedirect
import pymysql
from SystemOwner import views

app_name = "User"

def Index(request):
    d_dict = {}
    return render(request,'index.html',d_dict)

def RedirectSplash(request):
    d_dict = {}
    return render(request,'main.html',d_dict)

def About(request):
    d_dict = {}
    return render(request,'aboutus.html',d_dict)

def Login(request):
    d_dict = {}
    return render(request,'login.html',d_dict)

def LoginAttempt(request):

    if request.method == "POST":
        
        email = request.POST.get('emailid')
        pwd = request.POST.get('password')
        print(email)
        pk_list = (email,pwd)
        print(pk_list)
        select_user = ("SELECT * FROM User WHERE email_id = %s AND password = %s")
        con = pymysql.connect(host='ift540.cyhc1qzz7e7u.us-west-2.rds.amazonaws.com',
                            port = 3306,
                             user='IFT540PSP',
                             password='IFT540PSP',
                             db='pvsystem')

        cur = con.cursor()
        cur.execute(select_user,pk_list)
        row = cur.fetchone() #to fetch the last autogenerated user_id
        if not cur.rowcount:
            result1 = {'key':1}
            return render(request,'login.html',result1)
        else:
            #saving userid in session
            request.session['userid'] = row[0]
            result1 = {'key':row[0]}
            return views.OwnerView(request)
            #return render(request,'SystemOwnerWelcome.html',result1)

def Register(request):
    d_dict = {}
    return render(request,'register.html',d_dict)

def RegisterUser(request):

    if request.method == "POST":
        fname = request.POST.get('firstname')
        lname = request.POST.get('lastname')
        emailid = request.POST.get('emailid')
        pwd = request.POST.get('password')
        utype = request.POST.get('usertype')
        pk_list = (fname,lname,utype,emailid,pwd)
        add_user = ("INSERT INTO User (first_name, last_name, user_role, email_id, password)"
                    "VALUES (%s, %s, %s, %s, %s)")
        select_user = ("SELECT * FROM User WHERE email_id = %s")
        con = pymysql.connect(host='ift540.cyhc1qzz7e7u.us-west-2.rds.amazonaws.com',
                            port = 3306,
                             user='IFT540PSP',
                             password='IFT540PSP',
                             db='pvsystem')

        cur = con.cursor()
        cur.execute(select_user,pk_list[3])
        row = cur.fetchone()
        if cur.rowcount:
            result1 = {'key':1}
            return render(request,'register.html',result1)
        else:
            cur.execute(add_user,pk_list)
            userid = cur.lastrowid #to fetch the last autogenerated Pvsystem_id
            con.commit()
            result1 = {}
            return render(request,'login.html',result1)
